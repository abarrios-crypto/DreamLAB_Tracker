<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DreamLAB Tracker - Panel del Docente</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Fredoka+One&display=swap" rel="stylesheet">
    <style>
        :root {
            --kirby-pink: #f8b4d8;
            --kirby-blue: #a0e8f0;
            --kirby-green: #98fb98;
            --kirby-purple: #d8b4fe;
            --kirby-dark-text: #5c5470;
            --kirby-light-text: #6b7280;
            --bubblegum-pink: #F571A3;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #fdf2f8; /* Very light pink background */
        }
        .kirby-card {
            background-color: white;
            border-radius: 1.5rem;
            padding: 1rem; /* p-4 */
        }
        @media (min-width: 640px) { /* sm */
            .kirby-card {
                padding: 1.5rem; /* sm:p-6 */
            }
        }
        .kirby-button {
            border-radius: 9999px;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            transition: all 0.2s ease-in-out;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        .kirby-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .kirby-button-primary {
            background-color: #ec4899;
            color: white;
        }
        .kirby-button-primary:hover:not(:disabled) {
            background-color: #db2777;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(236, 72, 153, 0.4);
        }
        .kirby-button-secondary {
            background-color: #fbcfe8;
            color: #be185d;
        }
         .kirby-button-secondary:hover {
            background-color: #f9a8d4;
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #fdf2f8; }
        ::-webkit-scrollbar-thumb { background: #f9a8d4; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #ec4899; }
        
        /* Modal styles */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .modal-backdrop.visible {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-content {
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }
        .modal-backdrop.visible .modal-content {
            transform: scale(1);
        }

        .tab-button {
            padding: 0.5rem 1rem;
            font-weight: 600;
            border-radius: 9999px;
            cursor: pointer;
            transition: all 0.2s;
            color: #831843;
        }
        .tab-button.active {
            background-color: #ec4899;
            color: white;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background-color: #22c55e;
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease-in-out;
            z-index: 100;
        }
        .toast.show {
            transform: translateX(-50%) translateY(0);
        }
        .fredoka {
            font-family: 'Fredoka One', cursive;
        }
        details summary::-webkit-details-marker { display: none; }
        details > summary { list-style: none; }

        .unit-card {
            background: white;
            border: 2px solid var(--kirby-pink);
            border-radius: 1.5rem;
            box-shadow: 0 5px 0 0 var(--kirby-pink);
            transition: all 0.2s ease-in-out;
        }
        .unit-card[open] {
            transform: translateY(2px);
            box-shadow: 0 3px 0 0 var(--kirby-pink);
        }
        .unit-card summary {
            color: var(--bubblegum-pink);
        }
    </style>
</head>
<body class="antialiased">

    <!-- Main App Container -->
    <div id="app-container">
        <div class="relative min-h-screen md:flex">
            <!-- Mobile Menu Overlay -->
            <div id="menu-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden md:hidden"></div>

            <!-- Sidebar with Student List -->
            <aside id="sidebar" class="w-80 bg-white p-4 border-r border-pink-100 flex flex-col fixed inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0 transition-transform duration-300 ease-in-out z-40">
                <div class="flex items-center gap-3 mb-6">
                    <img src="https://placehold.co/40x40/fdf2f8/ec4899?text=DL" class="rounded-lg" alt="Logo de DreamLAB">
                    <h1 class="text-xl font-bold text-pink-800">Panel del Docente</h1>
                </div>

                <!-- Group Filter -->
                <div class="mb-4">
                    <label for="group-filter" class="block text-sm font-medium text-slate-700 mb-1">Filtrar por Grupo</label>
                    <select id="group-filter" onchange="renderStudentList()" class="w-full p-2 border border-slate-300 rounded-lg bg-white focus:ring-2 focus:ring-pink-500 focus:border-pink-500">
                        <option value="todos">Todos los Grupos</option>
                        <option value="5-1">Grupo 5-1</option>
                        <option value="5-2">Grupo 5-2</option>
                        <option value="5-3">Grupo 5-3</option>
                    </select>
                </div>

                <!-- Global Actions -->
                <div class="mb-4 px-2 space-y-2">
                    <button onclick="showProgramView()" class="kirby-button kirby-button-secondary w-full">
                        <i data-lucide="book-open" class="mr-2"></i>Programa del Curso
                    </button>
                    <button onclick="showTasksView()" class="kirby-button kirby-button-secondary w-full">
                        <i data-lucide="check-square" class="mr-2"></i>Tareas y Actividades
                    </button>
                     <button onclick="showStudentManagementView()" class="kirby-button kirby-button-secondary w-full">
                        <i data-lucide="users" class="mr-2"></i>Gestionar Alumnos
                    </button>
                    <button id="group-report-btn" onclick="generateGroupReport()" class="kirby-button kirby-button-primary w-full" disabled title="Seleccione un grupo para generar el informe">
                        <i data-lucide="file-text" class="mr-2"></i>Generar Informe
                    </button>
                </div>

                <div id="student-list" class="flex-grow overflow-y-auto pr-2 space-y-2">
                    <!-- Student list will be rendered here -->
                </div>
                <div class="mt-auto pt-4 border-t border-pink-100">
                    <div class="p-3 bg-pink-50 rounded-lg flex items-center gap-3">
                        <img id="instructor-avatar" src="" class="rounded-full w-10 h-10" alt="Avatar del instructor">
                        <div>
                            <p id="instructor-name" class="font-bold text-pink-900"></p>
                            <p class="text-sm text-pink-700">Instructor</p>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Main Content Area -->
            <main class="flex flex-col flex-1">
                <div class="p-4 sm:p-8 overflow-y-auto flex-grow">
                    <!-- Mobile Header -->
                    <div class="md:hidden flex items-center justify-between mb-6">
                        <button id="menu-toggle" class="p-2 rounded-md hover:bg-pink-100">
                            <i data-lucide="menu" class="w-6 h-6 text-pink-800"></i>
                        </button>
                        <h1 class="text-lg font-bold text-pink-800">DreamLAB Tracker</h1>
                    </div>
                    
                    <!-- Program View -->
                    <div id="program-content" class="hidden"></div>
                    
                    <!-- Tasks View -->
                    <div id="tasks-content" class="hidden"></div>
                    
                    <!-- Student Management View -->
                    <div id="student-management-content" class="hidden"></div>

                    <!-- Evaluation View -->
                    <div id="evaluation-content" class="hidden">
                        <div class="flex flex-col sm:flex-row items-center gap-4 mb-6">
                            <img id="selected-student-avatar" class="w-20 h-20 rounded-full" alt="">
                            <div class="text-center sm:text-left">
                                 <h2 class="text-xl sm:text-2xl font-bold text-pink-800">Panel de Evaluación:</h2>
                                 <p id="selected-student-name" class="text-3xl sm:text-4xl font-extrabold text-slate-800"></p>
                            </div>
                        </div>
                        
                        <!-- Kirby Progress Bar -->
                        <div id="progress-bar-container" class="my-6"></div>
    
                        <!-- EC Management Container -->
                        <div id="ec-management-container" class="mb-6"></div>
                        
                        <!-- Tab Navigation -->
                        <div class="mb-6 p-1.5 bg-pink-100 rounded-full inline-flex flex-wrap items-center">
                            <button class="tab-button active" onclick="switchEvalTab('evaluaciones')">Evaluaciones</button>
                            <button class="tab-button" onclick="switchEvalTab('verificar')">Verificar Certificado</button>
                        </div>
    
                        <!-- Evaluation Tabs -->
                        <div id="eval-evaluaciones" class="eval-tab-content grid grid-cols-1 lg:grid-cols-2 gap-6">
                             <div id="eval-parcial"></div>
                             <div id="eval-final"></div>
                        </div>
                        <div id="eval-verificar" class="eval-tab-content hidden grid grid-cols-1 gap-6">
                            <!-- Verification content will be rendered here -->
                        </div>
                    </div>

                    <div id="no-student-selected">
                        <div class="flex h-full items-center justify-center">
                            <div class="text-center">
                                <i data-lucide="users" class="mx-auto w-24 h-24 text-pink-300"></i>
                                <h2 class="mt-4 text-2xl font-bold text-pink-700">Selecciona un estudiante o una opción global</h2>
                                <p class="text-slate-500">Elige un estudiante para registrar sus evaluaciones o revisa el avance del programa.</p>
                            </div>
                        </div>
                    </div>
                </div>
                <footer class="text-center text-xs text-slate-500 py-4 border-t border-pink-100 bg-white">
                    © 2025 | Adriana A. Barrios Rodríguez | Todos los derechos reservados.
                </footer>
            </main>
        </div>
    </div>

    <!-- Student Summary Modal -->
    <div id="summary-modal" class="modal-backdrop">
        <div class="kirby-card w-full max-w-md md:max-w-2xl lg:max-w-4xl max-h-[90vh] flex flex-col modal-content">
            <div id="summary-modal-header" class="flex justify-between items-center mb-4">
                 <!-- Header content will be rendered here -->
            </div>
            <div id="summary-modal-body" class="overflow-y-auto pr-4">
                 <!-- Summary content will be rendered here -->
            </div>
        </div>
    </div>

    <!-- Practice Certificate Modal -->
    <div id="certificate-modal" class="modal-backdrop">
        <div class="w-full max-w-lg p-4 modal-content">
            <div id="certificate-content" class="bg-gradient-to-br from-pink-100 to-blue-100 p-8 rounded-2xl border-4 border-white shadow-2xl text-center" style="color: #5c5470;">
                <!-- Certificate content will be rendered here -->
            </div>
            <div class="mt-4 flex justify-center gap-4">
                 <button onclick="downloadCertificate()" class="kirby-button kirby-button-primary">
                    <i data-lucide="download" class="mr-2"></i> Descargar Comprobante
                </button>
                <button onclick="closeModal('certificate-modal')" class="kirby-button kirby-button-secondary">Cerrar</button>
            </div>
        </div>
    </div>
    
    <!-- Edit Task Modal -->
    <div id="edit-task-modal" class="modal-backdrop">
        <!-- Edit Task Modal Content will be rendered here -->
    </div>
    
    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

<script>
// --- DATABASE AND GAMIFICATION RULES (based on PDFs) ---
const HABILIDADES = {
    constancia: { name: "Constancia", totalPC: 20 },
    practica: { name: "Aplicación Práctica", totalPC: 20 },
    teoria: { name: "Comprensión Teórica", totalPC: 10 },
    interpretacion: { name: "Interpretación Clínica y Desarrollo Técnico", totalPC: 30 },
    analisis: { name: "Análisis Crítico", totalPC: 10 },
    argumentacion: { name: "Argumentación", totalPC: 10 },
};

const PRACTICAS = {
    hematocrito: "Determinación de hematocrito",
    globulos_rojos: "Conteo de glóbulos rojos",
    globulos_blancos: "Conteo de glóbulos blancos",
    plaquetas: "Conteo de plaquetas",
    extendido: "Extendido sanguíneo",
    diferencial: "Diferencial leucocitario",
    grupo_sanguineo: "Grupo Sanguíneo"
};

const UNIDADES_TEORICAS = {
    unidad1: "Unidad 1: Introducción a la Patología Clínica II",
    unidad2: "Unidad 2: Estudio Básico de la Sangre",
    unidad3: "Unidad 3: Banco de Sangre y Medicina Transfusional",
    unidad4: "Unidad 4: Valoración Metabólica Básica",
    unidad5: "Unidad 5: Valoración Renal Básica",
    unidad6: "Unidad 6: Valoración Hepática Básica",
    unidad7: "Unidad 7: Evaluación del Equilibrio Ácido-Base"
};

const RUBRICAS = {
    constancia: [
        { level: "Bio-Aprendiz", pc: 5, ec: 0, criteria: "Menos de 60% de rendimiento general en constancia" },
        { level: "Bio-Técnico", pc: 10, ec: 0, criteria: "Entre 60% y 79% de rendimiento general en constancia" },
        { level: "Bio-Maestro", pc: 20, ec: 0, criteria: "Entre 80% y 100% de rendimiento general en constancia" },
        { level: "Bio-Héroe", pc: 20, ec: 25, criteria: "Rendimiento perfecto y además motiva y apoya a compañeros" },
    ],
    practica: [
        { level: "Bio-Aprendiz", pc: 5, ec: 0, criteria: "Comete errores frecuentes en técnicas; requiere supervisión" },
        { level: "Bio-Técnico", pc: 10, ec: 0, criteria: "Aplica técnicas básicas con pequeños errores" },
        { level: "Bio-Maestro", pc: 20, ec: 0, criteria: "Ejecuta procedimientos autónomamente y correctamente" },
        { level: "Bio-Héroe", pc: 20, ec: 25, criteria: "Demuestra excelencia y liderazgo técnico" },
    ],
    teoria: [
        { range: [1.0, 4.9], level: "Bio-Aprendiz", pc: 3, ec: 0 },
        { range: [5.0, 7.9], level: "Bio-Técnico", pc: 6, ec: 0 },
        { range: [8.0, 8.9], level: "Bio-Maestro", pc: 10, ec: 0 },
        { range: [9.0, 10.0], level: "Bio-Héroe", pc: 10, ec: 25 },
    ],
    interpretacion: [
        { range: [1.0, 4.9], level: "Bio-Aprendiz", pc: 5, ec: 0 },
        { range: [5.0, 7.9], level: "Bio-Técnico", pc: 10, ec: 0 },
        { range: [8.0, 8.9], level: "Bio-Maestro", pc: 20, ec: 0 },
        { range: [9.0, 10.0], level: "Bio-Héroe", pc: 30, ec: 25 },
    ],
    analisis: [
        { level: "Bio-Aprendiz", pc: 3, ec: 0, criteria: "Análisis superficial, sin justificación robusta" },
        { level: "Bio-Técnico", pc: 6, ec: 0, criteria: "Análisis correcto pero con justificaciones limitadas" },
        { level: "Bio-Maestro", pc: 10, ec: 0, criteria: "Análisis profundo, bien justificado y con rigor conceptual" },
        { level: "Bio-Héroe", pc: 10, ec: 25, criteria: "Análisis crítico excepcional, propone mejoras o nuevas perspectivas" },
    ],
    argumentacion: [
        { level: "Bio-Aprendiz", pc: 3, ec: 0, criteria: "Argumentos débiles, comunicación poco clara" },
        { level: "Bio-Técnico", pc: 6, ec: 0, criteria: "Argumentos correctos pero poco persuasivos" },
        { level: "Bio-Maestro", pc: 10, ec: 0, criteria: "Argumentación sólida, comunicación efectiva y persuasiva" },
        { level: "Bio-Héroe", pc: 10, ec: 25, criteria: "Presentación sobresaliente, dominio total del tema y la audiencia" },
    ],
};

const courseProgramData = [
    { unit: "Unidad 1: Introducción a la Patología Clínica II", topics: [
        { name: "Alcance de la patología clínica en la biomedicina", completed: false, notes: "" },
        { name: "Aplicaciones prácticas de la etiología y factores de riesgo", completed: false, notes: "" },
        { name: "Patogénesis: fundamentos lesionales y fisiopatológicos", completed: false, notes: "" },
        { name: "Conceptos de síntoma, signo, síndrome y otros", completed: false, notes: "" },
        { name: "Medicina basada en la evidencia", completed: false, notes: "" }
    ]},
    { unit: "Unidad 2: Estudio Básico de la Sangre", topics: [
        { name: "Composición de la sangre", completed: false, notes: "" },
        { name: "Hematopoyesis y funciones de los diferentes tipos celulares", completed: false, notes: "" },
        { name: "Alteraciones hematológicas más comunes", completed: false, notes: "" },
        { name: "Interpretación de los resultados de un hemograma", completed: false, notes: "" },
        { name: "Pruebas específicas en hematología", completed: false, notes: "" }
    ]},
    { unit: "Unidad 3: Banco de Sangre y Medicina Transfusional", topics: [
        { name: "Principios de la donación de sangre", completed: false, notes: "" },
        { name: "Tipos de transfusiones y sus indicaciones", completed: false, notes: "" },
        { name: "Reacciones transfusionales", completed: false, notes: "" },
        { name: "Conservación y manejo de hemoderivados", completed: false, notes: "" },
        { name: "Tendencias en investigación en la Medicina Tranfusional", completed: false, notes: "" }
    ]},
    { unit: "Unidad 4: Valoración Metabólica Básica", topics: [
        { name: "Puntos claves del metabolismo de carbohidratos, lípidos y proteínas", completed: false, notes: "" },
        { name: "Marcadores bioquímicos", completed: false, notes: "" },
        { name: "Interpretación de perfiles metabólicos", completed: false, notes: "" }
    ]},
    { unit: "Unidad 5: Valoración Renal Básica", topics: [
        { name: "Fisiología renal básica", completed: false, notes: "" },
        { name: "Alteraciones renales y marcadores de función renal", completed: false, notes: "" },
        { name: "Enfermedades renales más frecuentes", completed: false, notes: "" }
    ]},
    { unit: "Unidad 6: Valoración Hepática Básica", topics: [
        { name: "Fisiología hepática básica", completed: false, notes: "" },
        { name: "Pruebas hepáticas y su interpretación", completed: false, notes: "" },
        { name: "Hepatopatías más comunes", completed: false, notes: "" }
    ]},
    { unit: "Unidad 7: Evaluación del Equilibrio Ácido-Base", topics: [
        { name: "Fisiología ácido-base", completed: false, notes: "" },
        { name: "Acidosis y alcalosis", completed: false, notes: "" },
        { name: "Interpretación de gases arteriales", completed: false, notes: "" }
    ]}
];

// --- DATA PERSISTENCE ---

function saveData() {
    localStorage.setItem('dreamlab_data', JSON.stringify(db));
}

function loadData() {
    const savedData = localStorage.getItem('dreamlab_data');
    if (savedData) {
        db = JSON.parse(savedData);
        // Ensure new data structures are present for older saved data
        db.students.forEach(s => {
            if (!s.constancia_details) {
                s.constancia_details = {
                    total_clases: 0, asistencias: 0, inasistencias: 0, justificantes: 0, retardos: 0,
                    total_tareas: 0, entregadas: 0, retardos_tareas: 0, no_entregadas: 0,
                    participacion: 'nula', bio_heroe_extra: false
                };
            }
        });
        if (!db.certificate_codes) {
            db.certificate_codes = [];
        }
        if (!db.courseProgram) {
            db.courseProgram = courseProgramData;
        }
        if (!db.tasks) {
            db.tasks = [];
        }
    } else {
        // This is the initial setup if no data is saved
        const studentNames_5_1 = [
            "AGUILAR GONZÁLEZ ALEXIS EMMANUEL", "ARMENTA FÉLIX GERMÁN", "ARREDONDO AGUILAR LITZY ESTEFANIA", 
            "ARREDONDO LÓPEZ NELLY ALEJANDRA", "CUADRAS LUGO DULCE MAYTE", "CUADRAS MORENO CHRISTOPHER IRÁN", 
            "ESCUDERO SALCEDO ANA BELÉN", "ESPINOZA LEYVA CINDY BELÉN", "GAMBOA LUGO KATHIA ISABEL", 
            "GARNICA NUÑEZ ANA CARMEN", "GERARDO BOJÓRQUEZ METZLI", "GONZALEZ RUBIO ENRIQUE", 
            "GUZMÁN LEÓN FÁTIMA ESTEFANÍA", "HUERTA NIEBLAS NAILEA", "JACOBO ISMERIO ANDRÉS ROGELIO", 
            "LIE ESPINOZA LUIS ROBERTO", "LIZARRAGA SÁNCHEZ CARLOS UVALDO", "LUNA RODRÍGUEZ WILLIAMS ALFREDO", 
            "MASCAREÑO MORALES LUIS MARIO", "MENDOZA VILLANUEVA LUIS ENRIQUE", "MONTENEGRO GONZÁLEZ MARÍA JOSÉ", 
            "ONTIVEROS MORALES BYANCA", "PARRA SÁNCHEZ VICTORIA AMAIRANY"
        ];
        const studentNames_5_2 = [
            "ACEVES FERNÁNDEZ ANA VALERIA", "ALANIZ FREGOSO ASHLEY ABISH", "AMBRIZ HERRERA MIGUEL ANGEL", 
            "ARREDONDO FELIX SEBASTIAN", "BARRERA GARCÍA DULCE ALEJANDRA", "CÁRDENAS PEREZ MARIA YOLANDA", 
            "CEBREROS GASTELUM NATALIA", "DOMINGUEZ PALMA MARIANA", "ESEVERRE QUEVEDO KEVIN ALEJANDRO", 
            "ESTRADA CRUZ CAMILA AURORA", "FELIZ OBESO ANA KAREN", "LEYVA VIDOVICH HERICK RAEL", 
            "MÁRQUEZ GASTELUM KARIME NATALY", "MENDOZA GARCÍA GISELLE ARELY", "NUÑEZ GALLARDO MARIAN LEYLANI", 
            "URREA LÓPEZ WENDY VIANNEY", "VILLAREAL LÓPEZ ANA MARÍA"
        ];
        const studentNames_5_3 = [
            "CALDERÓN GARCÍA BRITANNY RUBY", "CASTRO NIEBLA FRANCISCO JAVIER", "CAZAREZ JIMENEZ LORENA JACQUELINE", 
            "HERAS BELTRÁN JOSÉ ÁNGEL", "LUGO BUELNA SEBASTIAN", "PANUSOPULOS LÓPEZ NICKOLAS", 
            "QUINTERO MILLÁN CAROLINA", "ROJAS ESPINOZA MANUEL EDUARDO", "SOMERA MIRANDA ELIZA ALEJANDRA", 
            "VALENZUELA GARCÍA SUSAN GABRIELA", "VALENZUELA RENDÓN MARÍA CAMILA", "ALVARADO ROMERO MARIA FERNANDA", 
            "GUARECA MONJARDIN RAMÓN EDUARDO"
        ];

        let studentIdCounter = 1;
        const constancia_details_default = {
            total_clases: 0, asistencias: 0, inasistencias: 0, justificantes: 0, retardos: 0,
            total_tareas: 0, entregadas: 0, retardos_tareas: 0, no_entregadas: 0,
            participacion: 'nula', bio_heroe_extra: false
        };

        const allStudents = [
            ...studentNames_5_1.map(name => ({ id: studentIdCounter++, name, group: '5-1', evaluations: [], parciales: { practicas: {}, teoricos: {} }, constancia_details: {...constancia_details_default} })),
            ...studentNames_5_2.map(name => ({ id: studentIdCounter++, name, group: '5-2', evaluations: [], parciales: { practicas: {}, teoricos: {} }, constancia_details: {...constancia_details_default} })),
            ...studentNames_5_3.map(name => ({ id: studentIdCounter++, name, group: '5-3', evaluations: [], parciales: { practicas: {}, teoricos: {} }, constancia_details: {...constancia_details_default} }))
        ].map(student => ({ ...student, avatar: generateAvatarUrl(student.name) }));

        db = {
            students: allStudents,
            instructor: { name: "M.C. Adriana A. Barrios Rodríguez", avatar: "https://placehold.co/40x40/d1fae5/064e3b?text=AB" },
            certificate_codes: [],
            courseProgram: courseProgramData,
            tasks: []
        };
        saveData(); // Save the initial state
    }
}

function generateAvatarUrl(name) {
    const parts = name.split(' ');
    const firstLastNameInitial = parts[0][0];
    const nameInitial = parts[parts.length -1][0];
    const initials = `${firstLastNameInitial}${nameInitial}`.toUpperCase();
    const colors = ['f0abfc/4a044e', 'bae6fd/0c4a6e', 'fef08a/854d0e', 'd1fae5/064e3b', 'fecaca/991b1b', 'c7d2fe/4338ca'];
    const color = colors[Math.floor(Math.random() * colors.length)];
    return `https://placehold.co/80x80/${color}?text=${initials}`;
}

// --- STATE MANAGEMENT ---
let db;
let selectedStudentId = null;
let summaryChart = null;
let editingTaskId = null;

// --- INITIALIZATION ---
document.addEventListener('DOMContentLoaded', () => {
    loadData();
    document.getElementById('instructor-name').textContent = db.instructor.name;
    document.getElementById('instructor-avatar').src = db.instructor.avatar;
    renderStudentList();
    lucide.createIcons();
    setupResponsiveMenu();
});

function setupResponsiveMenu() {
    const menuToggle = document.getElementById('menu-toggle');
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('menu-overlay');

    menuToggle.addEventListener('click', toggleMenu);
    overlay.addEventListener('click', toggleMenu);
}

function toggleMenu() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('menu-overlay');
    sidebar.classList.toggle('-translate-x-full');
    overlay.classList.toggle('hidden');
}

// --- RENDERING FUNCTIONS ---
function renderStudentList() {
    const listContainer = document.getElementById('student-list');
    const filter = document.getElementById('group-filter').value;

    const filteredStudents = db.students.filter(student => filter === 'todos' || student.group === filter);

    listContainer.innerHTML = filteredStudents.map(student => {
        const totals = calculateTotals(student);
        return `
            <div 
                class="flex items-center p-3 rounded-lg cursor-pointer transition-colors ${student.id === selectedStudentId ? 'bg-pink-100' : 'hover:bg-pink-50'}"
                onclick="selectStudent(${student.id})"
            >
                <img src="${student.avatar}" class="w-12 h-12 rounded-full mr-4" alt="Avatar de ${student.name}">
                <div class="flex-grow overflow-hidden">
                    <p class="font-semibold text-slate-800 text-sm truncate">${student.name}</p>
                     <div class="flex items-center gap-2 sm:gap-4 mt-1">
                        <span class="text-xs font-bold text-pink-700 bg-pink-100 px-2 py-0.5 rounded-full inline-block">G-${student.group}</span>
                        <p class="text-sm text-slate-500 font-medium">
                            <span class="text-pink-600">${totals.pc}PC</span> | 
                            <span class="text-yellow-600">${totals.ec}EC</span>
                        </p>
                    </div>
                </div>
                <button class="p-1 rounded-full hover:bg-pink-200 text-pink-700 ml-2 flex-shrink-0" onclick="event.stopPropagation(); showStudentSummary(${student.id})">
                    <i data-lucide="eye"></i>
                </button>
            </div>
        `;
    }).join('');
    
    // Handle group report button state
    const groupReportBtn = document.getElementById('group-report-btn');
    if (filter === 'todos') {
        groupReportBtn.disabled = true;
        groupReportBtn.title = "Seleccione un grupo para generar el informe";
    } else {
        groupReportBtn.disabled = false;
        groupReportBtn.title = `Generar informe para el Grupo ${filter}`;
    }

    lucide.createIcons();
}


function renderEvaluationForms() {
    renderProgressBar();
    renderECManagement();
    
    const evalParcialContainer = document.getElementById('eval-parcial');
    const evalFinalContainer = document.getElementById('eval-final');
    
    evalParcialContainer.innerHTML = '';
    evalFinalContainer.innerHTML = '';
    
    evalParcialContainer.insertAdjacentHTML('beforeend', renderPracticasCard());
    evalParcialContainer.insertAdjacentHTML('beforeend', renderTeoriaCard());
    evalFinalContainer.insertAdjacentHTML('beforeend', renderConstanciaCard());
    evalFinalContainer.insertAdjacentHTML('beforeend', renderInterpretacionCard());
    evalFinalContainer.insertAdjacentHTML('beforeend', renderProyectoCard());

    renderVerificationTab();
    lucide.createIcons();
}

function renderProgressBar() {
    const student = db.students.find(s => s.id === selectedStudentId);
    if (!student) return;

    const totals = calculateTotals(student);
    const progressPercentage = Math.min(100, (totals.pc / 100) * 100);

    const container = document.getElementById('progress-bar-container');
    container.innerHTML = `
        <h3 class="text-xl font-bold text-pink-800 mb-2">Viaje de la Estrella (PC)</h3>
        <div class="w-full bg-pink-100 rounded-full h-8 relative p-1 border-2 border-pink-200 shadow-inner overflow-hidden">
            <div class="bg-gradient-to-r from-pink-200 to-pink-300 h-full rounded-full" style="position: absolute; top: 0; left: 0; width: 100%; z-index: 1;"></div>
            <div id="progress-bar-fill" class="bg-gradient-to-r from-yellow-300 to-amber-400 h-full rounded-full transition-all duration-500 ease-out relative z-index-2" style="width: ${progressPercentage}%;"></div>
            <div id="progress-star" class="absolute top-1/2 transform -translate-y-1/2 transition-all duration-500 ease-out" style="left: ${progressPercentage}%; z-index: 3;">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="#facc15" stroke="#c2410c" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-star" style="filter: drop-shadow(0 0 3px rgba(251, 191, 36, 0.7)); transform: translateX(-50%);">
                    <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                </svg>
            </div>
        </div>
        <p class="text-right mt-2 font-bold text-slate-700 text-lg">${totals.pc} / 100 PC</p>
    `;
}

function renderECManagement() {
    const student = db.students.find(s => s.id === selectedStudentId);
    if (!student) return;

    const totals = calculateTotals(student);
    const canConvert = totals.ec >= 100;

    const container = document.getElementById('ec-management-container');
    container.innerHTML = `
        <div class="kirby-card">
            <h3 class="text-xl font-bold text-pink-800 mb-4">Gestión de Estrellas de Crédito (EC)</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-start">
                <div>
                    <h4 class="font-semibold text-slate-700 mb-2">Añadir EC por Misiones Opcionales</h4>
                    <form id="form-add-ec" onsubmit="addOptionalEC(event)">
                        <div class="space-y-3">
                            <input type="number" name="amount" min="1" placeholder="Cantidad de EC" class="w-full p-2 border border-slate-300 rounded-lg" required>
                            <input type="text" name="reason" placeholder="Razón (Ej: Tesoro Patógeno Alfa)" class="w-full p-2 border border-slate-300 rounded-lg" required>
                            <button type="submit" class="kirby-button kirby-button-secondary w-full">
                                <i data-lucide="plus-circle" class="mr-2"></i>Añadir EC
                            </button>
                        </div>
                    </form>
                </div>
                <div class="bg-pink-50 p-4 rounded-lg text-center">
                    <p class="text-pink-800 font-semibold">Bóveda de EC ✨⭐</p>
                    <p class="text-4xl sm:text-5xl font-extrabold text-pink-700 my-2">${totals.ec}</p>
                    <p class="text-sm text-slate-500 mb-4">Se necesitan 100 EC para obtener 5 PC.</p>
                    <button onclick="convertECtoPC()" class="kirby-button kirby-button-primary w-full" ${!canConvert ? 'disabled' : ''}>
                        <i data-lucide="gift" class="mr-2"></i>Convertir 100 EC a 5 PC
                    </button>
                </div>
            </div>
        </div>
    `;
    lucide.createIcons();
}

function renderPracticasCard() {
    const student = db.students.find(s => s.id === selectedStudentId);
    const hasPracticaFinal = student.evaluations.some(e => e.habilidad === 'practica');
    const practicasCount = Object.keys(student.parciales.practicas).length;
    
    return `
        <div class="kirby-card">
            <h3 class="text-xl font-bold text-pink-800 mb-2">${HABILIDADES.practica.name}</h3>
            <p class="text-sm text-slate-500 mb-4">Registre el nivel de cada práctica.</p>
            <form id="form-practica" onsubmit="saveParciales(event, 'practicas')">
                <div class="space-y-3 max-h-80 overflow-y-auto pr-2 mb-4">
                    ${Object.keys(PRACTICAS).map(key => {
                        const practiceLevel = student.parciales.practicas[key];
                        const isGraded = practiceLevel && practiceLevel > 0;
                        return `
                        <div class="flex items-center gap-2">
                            <div class="flex-grow">
                                <label class="block text-sm font-medium text-slate-700 mb-1">${PRACTICAS[key]}</label>
                                <select name="${key}" class="w-full p-2 border border-slate-300 rounded-lg bg-white" ${hasPracticaFinal ? 'disabled' : ''}>
                                    <option value="0" ${!practiceLevel ? 'selected' : ''}>Sin calificar</option>
                                    <option value="1" ${practiceLevel == 1 ? 'selected' : ''}>Bio-Aprendiz</option>
                                    <option value="2" ${practiceLevel == 2 ? 'selected' : ''}>Bio-Técnico</option>
                                    <option value="3" ${practiceLevel == 3 ? 'selected' : ''}>Bio-Maestro</option>
                                    <option value="4" ${practiceLevel == 4 ? 'selected' : ''}>Bio-Héroe</option>
                                </select>
                            </div>
                            <button type="button" class="mt-6 p-2 rounded-full kirby-button-secondary" onclick="generatePracticeCertificate('${key}')" title="Emitir Comprobante" ${!isGraded || hasPracticaFinal ? 'disabled' : ''}>
                                <i data-lucide="award"></i>
                            </button>
                        </div>
                    `}).join('')}
                </div>
                <div class="flex flex-col sm:flex-row gap-2">
                    <button type="submit" class="kirby-button kirby-button-secondary w-full" ${hasPracticaFinal ? 'disabled' : ''}>Guardar Avances</button>
                    ${hasPracticaFinal
                        ? `<button type="button" onclick="modifyEvaluation('practica')" class="kirby-button kirby-button-secondary w-full">Modificar Calificación Final</button>`
                        : `<button type="button" onclick="calculateFinalPractica()" class="kirby-button kirby-button-primary w-full" ${practicasCount < 7 ? 'disabled' : ''}>Calcular Nivel Final</button>`
                    }
                </div>
            </form>
        </div>
    `;
}

function renderTeoriaCard() {
    const student = db.students.find(s => s.id === selectedStudentId);
    const hasTeoriaFinal = student.evaluations.some(e => e.habilidad === 'teoria');
    const teoricosCount = Object.keys(student.parciales.teoricos).filter(k => student.parciales.teoricos[k] !== null && student.parciales.teoricos[k] !== '').length;

    return `
        <div class="kirby-card">
            <h3 class="text-xl font-bold text-pink-800 mb-2">${HABILIDADES.teoria.name}</h3>
            <p class="text-sm text-slate-500 mb-4">Registre la calificación de cada unidad.</p>
            <form id="form-teoria" onsubmit="saveParciales(event, 'teoricos')">
                <div class="space-y-3 max-h-80 overflow-y-auto pr-2 mb-4">
                    ${Object.keys(UNIDADES_TEORICAS).map(key => {
                        const unitScore = student.parciales.teoricos[key];
                        const isGraded = unitScore !== undefined && unitScore !== null && unitScore !== '';
                        return `
                        <div>
                            <label class="block text-sm font-medium text-slate-700 truncate" title="${UNIDADES_TEORICAS[key]}">${UNIDADES_TEORICAS[key]}</label>
                            <div class="flex items-center gap-2">
                                <input type="number" name="${key}" min="0" max="10" step="0.1" placeholder="0-10" class="w-full p-2 border border-slate-300 rounded-lg" value="${unitScore || ''}" ${hasTeoriaFinal ? 'disabled' : ''}>
                                <button type="button" class="p-2 rounded-full kirby-button-secondary" onclick="generateTeoriaCertificate('${key}')" title="Emitir Comprobante" ${!isGraded || hasTeoriaFinal ? 'disabled' : ''}>
                                    <i data-lucide="file-check"></i>
                                </button>
                            </div>
                        </div>
                    `}).join('')}
                </div>
                 <div class="flex flex-col sm:flex-row gap-2">
                    <button type="submit" class="kirby-button kirby-button-secondary w-full" ${hasTeoriaFinal ? 'disabled' : ''}>Guardar Avances</button>
                    ${hasTeoriaFinal
                        ? `<button type="button" onclick="modifyEvaluation('teoria')" class="kirby-button kirby-button-secondary w-full">Modificar Calificación Final</button>`
                        : `<button type="button" onclick="calculateFinalTeoria()" class="kirby-button kirby-button-primary w-full" ${teoricosCount < 7 ? 'disabled' : ''}>Calcular Nivel Final</button>`
                    }
                </div>
            </form>
        </div>
    `;
}

function renderConstanciaCard() {
    const student = db.students.find(s => s.id === selectedStudentId);
    const hasConstancia = student.evaluations.some(e => e.habilidad === 'constancia');
    const d = student.constancia_details;
    return `
       <div class="kirby-card lg:col-span-2">
            <h3 class="text-xl font-bold text-pink-800 mb-4">${HABILIDADES.constancia.name}</h3>
            <form id="form-constancia" onsubmit="event.preventDefault(); saveConstanciaDetails();">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Asistencia -->
                    <div>
                        <h4 class="font-semibold text-slate-700 mb-2">Asistencia</h4>
                        <div class="space-y-2">
                           <div><label class="text-sm font-medium">Total de Clases del Semestre</label><input type="number" name="total_clases" value="${d.total_clases}" class="w-full p-2 mt-1 border rounded-lg" ${hasConstancia ? 'disabled' : ''}></div>
                           <div><label class="text-sm font-medium">Asistencias</label><input type="number" name="asistencias" value="${d.asistencias}" class="w-full p-2 mt-1 border rounded-lg" ${hasConstancia ? 'disabled' : ''}></div>
                           <div><label class="text-sm font-medium">Inasistencias</label><input type="number" name="inasistencias" value="${d.inasistencias}" class="w-full p-2 mt-1 border rounded-lg" ${hasConstancia ? 'disabled' : ''}></div>
                           <div><label class="text-sm font-medium">Justificantes</label><input type="number" name="justificantes" value="${d.justificantes}" class="w-full p-2 mt-1 border rounded-lg" ${hasConstancia ? 'disabled' : ''}></div>
                           <div><label class="text-sm font-medium">Retardos</label><input type="number" name="retardos" value="${d.retardos}" class="w-full p-2 mt-1 border rounded-lg" ${hasConstancia ? 'disabled' : ''}></div>
                        </div>
                    </div>
                    <!-- Tareas -->
                    <div>
                        <h4 class="font-semibold text-slate-700 mb-2">Tareas</h4>
                        <div class="space-y-2">
                           <div><label class="text-sm font-medium">Total de Tareas del Semestre</label><input type="number" name="total_tareas" value="${d.total_tareas}" class="w-full p-2 mt-1 border rounded-lg" ${hasConstancia ? 'disabled' : ''}></div>
                           <div><label class="text-sm font-medium">Entregadas a tiempo</label><input type="number" name="entregadas" value="${d.entregadas}" class="w-full p-2 mt-1 border rounded-lg" ${hasConstancia ? 'disabled' : ''}></div>
                           <div><label class="text-sm font-medium">Entregas con retardo</label><input type="number" name="retardos_tareas" value="${d.retardos_tareas}" class="w-full p-2 mt-1 border rounded-lg" ${hasConstancia ? 'disabled' : ''}></div>
                           <div><label class="text-sm font-medium">No entregadas</label><input type="number" name="no_entregadas" value="${d.no_entregadas}" class="w-full p-2 mt-1 border rounded-lg" ${hasConstancia ? 'disabled' : ''}></div>
                        </div>
                    </div>
                    <!-- Participación -->
                    <div>
                        <h4 class="font-semibold text-slate-700 mb-2">Participación</h4>
                        <select name="participacion" class="w-full p-2 border rounded-lg bg-white" ${hasConstancia ? 'disabled' : ''}>
                            <option value="nula" ${d.participacion === 'nula' ? 'selected' : ''}>Nula</option>
                            <option value="poca" ${d.participacion === 'poca' ? 'selected' : ''}>Poca</option>
                            <option value="frecuente" ${d.participacion === 'frecuente' ? 'selected' : ''}>Frecuente</option>
                            <option value="persistente" ${d.participacion === 'persistente' ? 'selected' : ''}>Persistente</option>
                        </select>
                         <div class="mt-4 flex items-start">
                            <input type="checkbox" id="bio-heroe-extra" name="bio_heroe_extra" class="mt-1 h-4 w-4 text-pink-600 border-gray-300 rounded focus:ring-pink-500" ${d.bio_heroe_extra ? 'checked' : ''} ${hasConstancia ? 'disabled' : ''}>
                            <div class="ml-3 text-sm">
                                <label for="bio-heroe-extra" class="font-medium text-gray-700">Motiva y apoya a compañeros</label>
                                <p class="text-gray-500">(Requisito para Bio-Héroe)</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-6 flex flex-col sm:flex-row gap-2">
                    <button type="submit" class="kirby-button kirby-button-secondary w-full" ${hasConstancia ? 'disabled' : ''}>Guardar Avances</button>
                     ${hasConstancia
                        ? `<button type="button" onclick="modifyEvaluation('constancia')" class="kirby-button kirby-button-secondary w-full">Modificar Evaluación</button>`
                        : `<button type="button" onclick="calculateAndSubmitConstancia()" class="kirby-button kirby-button-primary w-full">Calcular Nivel de Constancia</button>`
                    }
                </div>
            </form>
        </div>
    `;
}

function renderInterpretacionCard(){
    const student = db.students.find(s => s.id === selectedStudentId);
    const hasInterpretacion = student.evaluations.some(e => e.habilidad === 'interpretacion');
    return `
        <div class="kirby-card">
            <h3 class="text-xl font-bold text-pink-800 mb-4">${HABILIDADES.interpretacion.name}</h3>
             <form id="form-interpretacion" onsubmit="submitFinalScore(event, 'interpretacion')">
                <p class="text-sm text-slate-500 mb-4">Evaluación única al final del semestre (semanas 13-14).</p>
                <input type="number" name="score" min="0" max="10" step="0.1" placeholder="Calificación (0-10)" class="w-full p-2 border border-slate-300 rounded-lg mb-4" required ${hasInterpretacion ? 'disabled' : ''}>
                ${hasInterpretacion
                    ? `<button type="button" onclick="modifyEvaluation('interpretacion')" class="kirby-button kirby-button-secondary w-full">Modificar Evaluación</button>`
                    : `<button type="submit" class="kirby-button kirby-button-primary w-full">Registrar Examen Práctico</button>`
                }
            </form>
        </div>
    `;
}

function renderProyectoCard() {
    const student = db.students.find(s => s.id === selectedStudentId);
    const hasProyecto = student.evaluations.some(e => e.habilidad === 'analisis');
    return `
       <div class="kirby-card">
            <h3 class="text-xl font-bold text-pink-800 mb-4">Proyecto Final</h3>
            <form id="form-proyecto" onsubmit="submitProyecto(event)">
                <div class="grid grid-cols-1 gap-6">
                    <div>
                        <h4 class="font-semibold text-slate-700 mb-2">${HABILIDADES.analisis.name}</h4>
                        <div class="space-y-2">
                            ${RUBRICAS.analisis.map((level, i) => `
                                <div>
                                    <input type="radio" name="analisis_level" value="${i}" id="analisis-level-${i}" class="hidden peer" required ${hasProyecto ? 'disabled' : ''}>
                                    <label for="analisis-level-${i}" class="block p-2 border border-slate-200 rounded-lg cursor-pointer peer-checked:border-pink-500 peer-checked:bg-pink-50 text-sm">
                                        <p class="font-bold text-pink-700">${level.level}</p>
                                        <p class="text-slate-600">${level.criteria}</p>
                                    </label>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div>
                        <h4 class="font-semibold text-slate-700 mb-2">${HABILIDADES.argumentacion.name}</h4>
                        <div class="space-y-2">
                             ${RUBRICAS.argumentacion.map((level, i) => `
                                <div>
                                    <input type="radio" name="argumentacion_level" value="${i}" id="argumentacion-level-${i}" class="hidden peer" required ${hasProyecto ? 'disabled' : ''}>
                                    <label for="argumentacion-level-${i}" class="block p-2 border border-slate-200 rounded-lg cursor-pointer peer-checked:border-pink-500 peer-checked:bg-pink-50 text-sm">
                                        <p class="font-bold text-pink-700">${level.level}</p>
                                        <p class="text-slate-600">${level.criteria}</p>
                                    </label>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
                 ${hasProyecto
                    ? `<button type="button" onclick="modifyEvaluation('proyecto')" class="kirby-button kirby-button-secondary w-full mt-6">Modificar Evaluación</button>`
                    : `<button type="submit" class="kirby-button kirby-button-primary w-full mt-6">Registrar Proyecto Final</button>`
                }
            </form>
        </div>
    `;
}

function renderVerificationTab() {
    const container = document.getElementById('eval-verificar');
    container.innerHTML = `
        <div class="kirby-card">
            <h3 class="text-xl font-bold text-pink-800 mb-4">Verificar Autenticidad de Comprobante</h3>
            <form id="form-verify" onsubmit="event.preventDefault(); verifyCertificateCode();">
                <div class="flex flex-col sm:flex-row gap-2">
                    <input id="verification-code-input" type="text" placeholder="Ingrese el código de verificación" class="w-full p-2 border border-slate-300 rounded-lg uppercase" required>
                    <button type="submit" class="kirby-button kirby-button-primary w-full sm:w-auto">
                        <i data-lucide="scan-line" class="mr-2"></i>Verificar
                    </button>
                </div>
            </form>
            <div id="verification-result" class="mt-4"></div>
        </div>
        <div class="kirby-card">
            <h3 class="text-xl font-bold text-pink-800 mb-4">Historial de Certificados Emitidos</h3>
            <div class="max-h-96 overflow-y-auto pr-2 space-y-2">
                ${db.certificate_codes.length > 0 ? [...db.certificate_codes].reverse().map(c => `
                    <div class="p-3 bg-slate-50 rounded-lg text-sm">
                        <div class="flex justify-between items-center">
                            <p class="font-bold text-slate-800">${c.studentName}</p>
                            <p class="font-mono text-pink-700 bg-pink-100 px-2 py-0.5 rounded">${c.code}</p>
                        </div>
                        <p class="text-slate-600">${c.practiceName} - <strong>${c.level}</strong></p>
                        <p class="text-xs text-slate-500 mt-1">Emitido: ${c.date}</p>
                    </div>
                `).join('') : '<p class="text-sm text-slate-500">No se han emitido certificados.</p>'}
            </div>
        </div>
    `;
    lucide.createIcons();
}

// --- EVENT HANDLERS & LOGIC ---

function selectStudent(studentId) {
    selectedStudentId = studentId;
    document.getElementById('evaluation-content').classList.remove('hidden');
    document.getElementById('program-content').classList.add('hidden');
    document.getElementById('tasks-content').classList.add('hidden');
    document.getElementById('student-management-content').classList.add('hidden');
    document.getElementById('no-student-selected').classList.add('hidden');
    
    const student = db.students.find(s => s.id === studentId);
    document.getElementById('selected-student-avatar').src = student.avatar;
    document.getElementById('selected-student-name').textContent = student.name;
    
    if (window.innerWidth < 768) { // md breakpoint
        toggleMenu();
    }

    renderStudentList();
    renderEvaluationForms();
    switchEvalTab('evaluaciones');
}

function switchEvalTab(tabId) {
    document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
    document.querySelector(`.tab-button[onclick="switchEvalTab('${tabId}')"]`).classList.add('active');
    document.querySelectorAll('.eval-tab-content').forEach(c => c.classList.add('hidden'));
    document.getElementById(`eval-${tabId}`).classList.remove('hidden');
    
    if (tabId === 'verificar') {
        renderVerificationTab();
    } else if (tabId === 'evaluaciones') {
        const evalParcialContainer = document.getElementById('eval-parcial');
        const evalFinalContainer = document.getElementById('eval-final');
        evalParcialContainer.classList.add('grid', 'grid-cols-1', 'lg:grid-cols-2', 'gap-6');
        evalFinalContainer.classList.add('grid', 'grid-cols-1', 'lg:grid-cols-2', 'gap-6');
        evalParcialContainer.parentElement.appendChild(evalFinalContainer);
    }
}

function verifyCertificateCode() {
    const codeInput = document.getElementById('verification-code-input').value.trim().toUpperCase();
    const resultContainer = document.getElementById('verification-result');
    if (!codeInput) {
        resultContainer.innerHTML = '';
        return;
    }

    const record = db.certificate_codes.find(c => c.code === codeInput);
    
    if (record) {
        resultContainer.innerHTML = `
            <div class="p-4 bg-green-50 border-l-4 border-green-500 rounded-r-lg">
                <div class="flex items-center gap-3">
                    <i data-lucide="check-circle" class="w-8 h-8 text-green-600"></i>
                    <div>
                        <p class="font-bold text-green-800">Certificado Válido</p>
                        <p class="text-sm text-slate-700">Emitido a: <strong>${record.studentName}</strong></p>
                        <p class="text-sm text-slate-600">${record.practiceName} (${record.level})</p>
                        <p class="text-xs text-slate-500">Fecha: ${record.date}</p>
                    </div>
                </div>
            </div>
        `;
    } else {
         resultContainer.innerHTML = `
            <div class="p-4 bg-red-50 border-l-4 border-red-500 rounded-r-lg">
                <div class="flex items-center gap-3">
                    <i data-lucide="x-circle" class="w-8 h-8 text-red-600"></i>
                    <div>
                        <p class="font-bold text-red-800">Certificado Inválido</p>
                        <p class="text-sm text-slate-700">El código no se encontró en el registro. El certificado puede haber sido alterado.</p>
                    </div>
                </div>
            </div>
        `;
    }
    lucide.createIcons();
}

function calculateTotals(student) {
    return student.evaluations.reduce((acc, curr) => {
        acc.pc += curr.pc;
        acc.ec += curr.ec;
        return acc;
    }, { pc: 0, ec: 0 });
}

function addEvaluation(habilidad, levelData, activityName = null) {
    const student = db.students.find(s => s.id === selectedStudentId);
    student.evaluations.push({
        id: Date.now(),
        habilidad,
        activity: activityName || HABILIDADES[habilidad].name,
        level: levelData.level,
        pc: levelData.pc,
        ec: levelData.ec,
        date: new Date().toLocaleDateString('es-MX')
    });
    saveData();
    renderStudentList();
    renderEvaluationForms();
}

function modifyEvaluation(habilidad) {
    const student = db.students.find(s => s.id === selectedStudentId);
    if (!student) return;

    let habilidadName = '';

    if (habilidad === 'proyecto') {
        student.evaluations = student.evaluations.filter(ev => ev.habilidad !== 'analisis' && ev.habilidad !== 'argumentacion');
        habilidadName = 'Proyecto Final';
    } else {
        student.evaluations = student.evaluations.filter(ev => ev.habilidad !== habilidad);
        habilidadName = HABILIDADES[habilidad].name;
    }
    
    showToast(`Evaluación de ${habilidadName} reiniciada. Puede registrar un nuevo valor.`);
    saveData();
    renderStudentList();
    renderEvaluationForms();
}


// Form Submissions
function addOptionalEC(event) {
    event.preventDefault();
    const form = event.target;
    const amount = parseInt(form.elements.amount.value);
    const reason = form.elements.reason.value;
    
    if (isNaN(amount) || amount <= 0) return;

    const student = db.students.find(s => s.id === selectedStudentId);
    student.evaluations.push({
        id: Date.now(),
        habilidad: 'recompensa',
        activity: reason,
        level: 'Misión Opcional',
        pc: 0,
        ec: amount,
        date: new Date().toLocaleDateString('es-MX')
    });

    saveData();
    renderStudentList();
    renderECManagement();
    renderProgressBar();
    showToast(`${amount} EC añadidos a ${student.name}.`);
    form.reset();
}

function convertECtoPC() {
    const student = db.students.find(s => s.id === selectedStudentId);
    const totals = calculateTotals(student);

    if (totals.ec < 100) return;

    student.evaluations.push({
        id: Date.now(),
        habilidad: 'conversion',
        activity: 'Canje de 100 EC por 5 PC',
        level: 'Conversión',
        pc: 5,
        ec: -100,
        date: new Date().toLocaleDateString('es-MX')
    });

    saveData();
    renderStudentList();
    renderECManagement();
    renderProgressBar();
    showToast(`Canje realizado: -100 EC, +5 PC para ${student.name}.`);
}

function saveParciales(event, type) {
    event.preventDefault();
    const student = db.students.find(s => s.id === selectedStudentId);
    const formData = new FormData(event.target);
    student.parciales[type] = {}; // Clear old data before saving new
    for (const [key, value] of formData.entries()) {
        if (value !== null && value !== '0' && value !== '') {
             student.parciales[type][key] = parseFloat(value);
        } else if (value === '') {
            student.parciales[type][key] = null;
        } else {
            student.parciales[type][key] = parseFloat(value);
        }
    }
    saveData();
    renderPartialEvalForms();
    showToast('Avances guardados exitosamente.');
}

function calculateFinalPractica() {
    const student = db.students.find(s => s.id === selectedStudentId);
    const practiceScores = Object.values(student.parciales.practicas);
    if (practiceScores.length < 7) return;

    const sum = practiceScores.reduce((acc, score) => acc + score, 0);
    const avg = sum / practiceScores.length;

    let finalLevelIndex;
    if (avg < 1.75) finalLevelIndex = 0; // Bio-Aprendiz
    else if (avg < 2.75) finalLevelIndex = 1; // Bio-Técnico
    else if (avg < 3.5) finalLevelIndex = 2; // Bio-Maestro
    else finalLevelIndex = 3; // Bio-Héroe

    const levelData = RUBRICAS.practica[finalLevelIndex];
    addEvaluation('practica', levelData, 'Promedio Final de Prácticas');
}

function calculateFinalTeoria() {
    const student = db.students.find(s => s.id === selectedStudentId);
    const theoryScores = Object.values(student.parciales.teoricos);
    if (theoryScores.length < 7) return;

    const sum = theoryScores.reduce((acc, score) => acc + score, 0);
    const avg = sum / theoryScores.length;

    const levelData = RUBRICAS.teoria.find(r => avg >= r.range[0] && avg <= r.range[1]);
    if (levelData) {
        addEvaluation('teoria', levelData, `Promedio Final Teórico (${avg.toFixed(2)})`);
    }
}

function saveConstanciaDetails() {
    const student = db.students.find(s => s.id === selectedStudentId);
    const form = document.getElementById('form-constancia');
    const formData = new FormData(form);

    student.constancia_details.total_clases = parseInt(formData.get('total_clases')) || 0;
    student.constancia_details.asistencias = parseInt(formData.get('asistencias')) || 0;
    student.constancia_details.inasistencias = parseInt(formData.get('inasistencias')) || 0;
    student.constancia_details.justificantes = parseInt(formData.get('justificantes')) || 0;
    student.constancia_details.retardos = parseInt(formData.get('retardos')) || 0;
    student.constancia_details.total_tareas = parseInt(formData.get('total_tareas')) || 0;
    student.constancia_details.entregadas = parseInt(formData.get('entregadas')) || 0;
    student.constancia_details.retardos_tareas = parseInt(formData.get('retardos_tareas')) || 0;
    student.constancia_details.no_entregadas = parseInt(formData.get('no_entregadas')) || 0;
    student.constancia_details.participacion = formData.get('participacion');
    student.constancia_details.bio_heroe_extra = form.elements['bio_heroe_extra'].checked;
    
    saveData();
    showToast('Avances de constancia guardados.');
}


function calculateAndSubmitConstancia() {
    saveConstanciaDetails(); // Save latest values first
    const student = db.students.find(s => s.id === selectedStudentId);
    const d = student.constancia_details;

    if (d.total_clases <= 0) {
        showToast("Error: Ingrese el total de clases del semestre.");
        return;
    }
     if (d.total_tareas <= 0) {
        showToast("Error: Ingrese el total de tareas del semestre.");
        return;
    }

    // Asistencia Score (40%)
    const effectiveAbsences = d.inasistencias + Math.floor(d.retardos / 3);
    const effectiveAttendance = ((d.total_clases - effectiveAbsences) / d.total_clases) * 100;
    const asistenciaScore = (Math.max(0, effectiveAttendance) / 100) * 40;

    // Tareas Score (40%)
    const effectiveTareas = d.entregadas + (d.retardos_tareas * 0.5); // Late tasks worth half
    const tareasScore = (effectiveTareas / d.total_tareas) * 40;

    // Participacion Score (20%)
    let participacionScore = 0;
    switch(d.participacion) {
        case 'poca': participacionScore = 5; break;
        case 'frecuente': participacionScore = 15; break;
        case 'persistente': participacionScore = 20; break;
    }

    const totalScore = Math.max(0, asistenciaScore) + Math.max(0, tareasScore) + participacionScore;

    let levelIndex;
    if (totalScore < 60) levelIndex = 0; // Bio-Aprendiz
    else if (totalScore < 80) levelIndex = 1; // Bio-Técnico
    else if (totalScore < 100 || (totalScore >= 100 && !d.bio_heroe_extra)) levelIndex = 2; // Bio-Maestro
    else levelIndex = 3; // Bio-Héroe only if score is 100 AND extra is checked

    addEvaluation('constancia', RUBRICAS.constancia[levelIndex], `Constancia (${totalScore.toFixed(1)}%)`);
}


function submitFinal(event, habilidad) {
    event.preventDefault();
    const levelIndex = event.target.elements.level.value;
    const levelData = RUBRICAS[habilidad][levelIndex];
    addEvaluation(habilidad, levelData);
}

function submitFinalScore(event, habilidad) {
    event.preventDefault();
    const score = parseFloat(event.target.elements.score.value);
    const levelData = RUBRICAS[habilidad].find(r => score >= r.range[0] && score <= r.range[1]);
    if (levelData) {
        addEvaluation(habilidad, levelData);
    }
}

function submitProyecto(event) {
    event.preventDefault();
    const analisisIndex = event.target.elements.analisis_level.value;
    const argumentacionIndex = event.target.elements.argumentacion_level.value;
    
    addEvaluation('analisis', RUBRICAS.analisis[analisisIndex], 'Proyecto Final - Análisis');
    addEvaluation('argumentacion', RUBRICAS.argumentacion[argumentacionIndex], 'Proyecto Final - Argumentación');
}

// Modal and UI helpers
function showStudentSummary(studentId) {
    const student = db.students.find(s => s.id === studentId);
    const totals = calculateTotals(student);
    const header = document.getElementById('summary-modal-header');
    const body = document.getElementById('summary-modal-body');

    header.innerHTML = `
        <h2 class="text-2xl sm:text-3xl font-bold text-pink-800">Resumen de Progreso</h2>
        <div class="flex items-center gap-2">
            <button onclick="downloadSummary(${student.id})" class="p-2 rounded-full hover:bg-pink-100 text-pink-700" title="Descargar Resumen">
                <i data-lucide="download-cloud"></i>
            </button>
            <button onclick="closeModal('summary-modal')" class="p-2 rounded-full hover:bg-pink-100">
                <i data-lucide="x"></i>
            </button>
        </div>
    `;

    const pcByHabilidad = Object.keys(HABILIDADES).reduce((acc, key) => {
        acc[key] = { name: HABILIDADES[key].name, pc: 0, total: HABILIDADES[key].totalPC };
        return acc;
    }, {});

    student.evaluations.forEach(ev => {
        if(pcByHabilidad[ev.habilidad]) {
            pcByHabilidad[ev.habilidad].pc += ev.pc;
        }
    });

    body.innerHTML = `
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 sm:gap-6 mb-6">
            <div class="kirby-card text-center col-span-1 sm:col-span-3">
                <img src="${student.avatar}" class="w-24 h-24 rounded-full mx-auto mb-3" />
                <h3 class="text-xl sm:text-2xl font-bold text-slate-800">${student.name}</h3>
                <span class="text-md font-bold text-pink-700 bg-pink-100 px-3 py-1 rounded-full inline-block">Grupo ${student.group}</span>
            </div>
            <div class="kirby-card text-center bg-pink-50 col-span-1 sm:col-span-3 md:col-span-1">
                <i data-lucide="heart" class="w-12 h-12 mx-auto text-pink-500"></i>
                <p class="text-4xl sm:text-5xl font-extrabold text-pink-800 mt-2">${totals.pc}</p>
                <p class="text-pink-700 font-semibold">Puntos de Corazón (PC) de 100</p>
            </div>
            <div class="kirby-card text-center bg-yellow-50 col-span-1 sm:col-span-3 md:col-span-2">
                <i data-lucide="star" class="w-12 h-12 mx-auto text-yellow-500"></i>
                <p class="text-4xl sm:text-5xl font-extrabold text-yellow-800 mt-2">${totals.ec}</p>
                <p class="text-yellow-700 font-semibold">Estrellas de Crédito (EC)</p>
            </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="kirby-card">
                 <h3 class="text-xl font-bold text-pink-800 mb-4">Desglose de PC por Habilidad</h3>
                 <canvas id="summaryChart"></canvas>
            </div>
            <div class="kirby-card">
                <h3 class="text-xl font-bold text-pink-800 mb-4">Historial de Transacciones</h3>
                <div class="space-y-3 max-h-96 overflow-y-auto pr-2">
                ${student.evaluations.length > 0 ? [...student.evaluations].reverse().map(ev => {
                    const pcText = ev.pc !== 0 ? `<span class="font-medium ${ev.pc > 0 ? 'text-pink-600' : 'text-red-600'}">${ev.pc > 0 ? '+' : ''}${ev.pc} PC</span>` : '';
                    const ecText = ev.ec !== 0 ? `<span class="font-medium ${ev.ec > 0 ? 'text-yellow-600' : 'text-red-600'}">${ev.ec > 0 ? '+' : ''}${ev.ec} EC</span>` : '';
                    const separator = ev.pc !== 0 && ev.ec !== 0 ? ', ' : '';

                    return `
                    <div class="p-3 bg-slate-50 rounded-lg">
                        <div class="flex justify-between items-center">
                            <p class="font-semibold text-slate-800">${ev.activity}</p>
                            <p class="text-sm font-medium text-slate-600">${ev.date}</p>
                        </div>
                        <p class="text-sm my-1"><strong class="text-slate-700">${ev.level}</strong> | ${pcText}${separator}${ecText}</p>
                    </div>`
                }).join('') : '<p class="text-sm text-slate-500 p-3 bg-slate-50 rounded-lg">Aún no hay transacciones registradas.</p>'}
                </div>
            </div>
        </div>
    `;

    document.getElementById('summary-modal').classList.add('visible');
    lucide.createIcons();
    createSummaryChart(pcByHabilidad);
}

function downloadSummary(studentId) {
    const student = db.students.find(s => s.id === studentId);
    if (!student) return;

    const totals = calculateTotals(student);
    const pcByHabilidad = Object.keys(HABILIDADES).reduce((acc, key) => {
        acc[key] = { name: HABILIDADES[key].name, pc: 0, total: HABILIDADES[key].totalPC };
        student.evaluations.forEach(ev => {
            if (ev.habilidad === key) {
                acc[key].pc += ev.pc;
            }
        });
        return acc;
    }, {});

    let reportContent = `======================================\n`;
    reportContent += `  RESUMEN DE PROGRESO - DREAMLAB\n`;
    reportContent += `======================================\n\n`;
    reportContent += `Estudiante: ${student.name}\n`;
    reportContent += `Grupo: ${student.group}\n`;
    reportContent += `Fecha de Emisión: ${new Date().toLocaleDateString('es-MX', { year: 'numeric', month: 'long', day: 'numeric' })}\n\n`;
    
    reportContent += `--------------------------------------\n`;
    reportContent += ` RESUMEN GENERAL\n`;
    reportContent += `--------------------------------------\n`;
    reportContent += `Puntos de Corazón (PC): ${totals.pc} / 100\n`;
    reportContent += `Estrellas de Crédito (EC): ${totals.ec}\n\n`;

    reportContent += `--------------------------------------\n`;
    reportContent += ` DESGLOSE DE PC POR HABILIDAD\n`;
    reportContent += `--------------------------------------\n`;
    Object.values(pcByHabilidad).forEach(h => {
        reportContent += `- ${h.name.padEnd(40, ' ')}: ${String(h.pc).padStart(2)} / ${h.total} PC\n`;
    });
    reportContent += `\n`;

    reportContent += `--------------------------------------\n`;
    reportContent += ` HISTORIAL DE TRANSACCIONES\n`;
    reportContent += `--------------------------------------\n`;
    if (student.evaluations.length > 0) {
        [...student.evaluations].reverse().forEach(ev => {
            const pcText = ev.pc !== 0 ? `${ev.pc > 0 ? '+' : ''}${ev.pc} PC` : '';
            const ecText = ev.ec !== 0 ? `${ev.ec > 0 ? '+' : ''}${ev.ec} EC` : '';
            const separator = ev.pc !== 0 && ev.ec !== 0 ? ', ' : '';
            
            reportContent += `[${ev.date}] ${ev.activity} (${ev.level})\n`;
            reportContent += `    -> ${pcText}${separator}${ecText}\n\n`;
        });
    } else {
        reportContent += `No hay transacciones registradas.\n`;
    }

    const blob = new Blob([reportContent], { type: 'text/plain;charset=utf-8' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    const safeName = student.name.replace(/ /g, '_').toLowerCase();
    link.download = `resumen_dreamlab_${safeName}.txt`;
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(link.href);
}

function generateGroupReport() {
    const group = document.getElementById('group-filter').value;
    if (group === 'todos') {
        showToast('Por favor, seleccione un grupo específico para generar el informe.');
        return;
    }

    const groupStudents = db.students.filter(s => s.group === group);
    
    let reportContent = `======================================\n`;
    reportContent += `  INFORME DE PROGRESO GRUPAL - DREAMLAB\n`;
    reportContent += `======================================\n\n`;
    reportContent += `Grupo: ${group}\n`;
    reportContent += `Fecha de Emisión: ${new Date().toLocaleDateString('es-MX', { year: 'numeric', month: 'long', day: 'numeric' })}\n`;
    reportContent += `Total de Alumnos: ${groupStudents.length}\n\n`;
    
    groupStudents.forEach((student, index) => {
        const totals = calculateTotals(student);
        const pcByHabilidad = Object.keys(HABILIDADES).reduce((acc, key) => {
            acc[key] = { name: HABILIDADES[key].name, pc: 0, total: HABILIDADES[key].totalPC };
            student.evaluations.forEach(ev => {
                if (ev.habilidad === key) {
                    acc[key].pc += ev.pc;
                }
            });
            return acc;
        }, {});

        reportContent += `--------------------------------------------------\n`;
        reportContent += ` ${index + 1}. ${student.name}\n`;
        reportContent += `--------------------------------------------------\n`;
        reportContent += `  - Puntos de Corazón (PC): ${totals.pc} / 100\n`;
        reportContent += `  - Estrellas de Crédito (EC): ${totals.ec}\n`;
        reportContent += `  - Desglose por Habilidad:\n`;
        Object.values(pcByHabilidad).forEach(h => {
            reportContent += `    * ${h.name.padEnd(40, ' ')}: ${String(h.pc).padStart(2)} / ${h.total} PC\n`;
        });
        reportContent += `\n`;
    });
    
    reportContent += `======================================\n`;
    reportContent += `  FIN DEL INFORME\n`;
    reportContent += `======================================\n`;

    const blob = new Blob([reportContent], { type: 'text/plain;charset=utf-8' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `informe_grupo_${group}.txt`;
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(link.href);
}

function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('visible');
    if (summaryChart) {
        summaryChart.destroy();
    }
}

function generatePracticeCertificate(practiceKey) {
    const student = db.students.find(s => s.id === selectedStudentId);
    const practiceLevelIndex = student.parciales.practicas[practiceKey];
    if (!practiceLevelIndex || practiceLevelIndex == 0) return;

    const levelData = RUBRICAS.practica[practiceLevelIndex - 1]; // -1 because array is 0-indexed
    const practiceName = PRACTICAS[practiceKey];
    const levelStars = '⭐'.repeat(practiceLevelIndex);

    const uniqueCode = crypto.randomUUID().split('-')[0].toUpperCase();
    const certificateRecord = {
        code: uniqueCode,
        studentId: student.id,
        studentName: student.name,
        practiceName: practiceName,
        level: levelData.level,
        type: 'practica',
        date: new Date().toLocaleDateString('es-MX')
    };
    db.certificate_codes.push(certificateRecord);
    saveData();

    const container = document.getElementById('certificate-content');
    container.innerHTML = `
        <h2 class="fredoka text-3xl font-bold tracking-wide" style="color: #F571A3;">Comprobante de Habilidad</h2>
        <p class="text-lg mt-1 font-semibold">${HABILIDADES.practica.name}</p>
        <div class="my-6">
            <p class="text-sm uppercase tracking-wider">Estudiante</p>
            <p class="text-2xl font-bold">${student.name}</p>
        </div>
        <div class="bg-white/70 rounded-lg p-4">
            <p class="text-sm uppercase tracking-wider">Práctica Realizada</p>
            <p class="text-xl font-semibold">${practiceName}</p>
        </div>
        <div class="my-6">
            <p class="text-5xl">${levelStars}</p>
            <p class="fredoka text-4xl mt-2" style="color: #6a4c9c;">${levelData.level}</p>
            <p class="mt-2 max-w-sm mx-auto">"${levelData.criteria}"</p>
        </div>
        <div class="text-xs text-slate-500 mt-6">
            <p>Emitido por: ${db.instructor.name}</p>
            <p>Fecha de Emisión: ${certificateRecord.date}</p>
        </div>
        <div class="mt-4 pt-4 border-t-2 border-dashed border-white/80">
             <p class="text-xs font-semibold">CÓDIGO DE VERIFICACIÓN</p>
             <p class="font-mono text-lg tracking-widest font-bold">${uniqueCode}</p>
        </div>
    `;
    
    document.getElementById('certificate-modal').classList.add('visible');
    lucide.createIcons();
}

function generateTeoriaCertificate(unitKey) {
    const student = db.students.find(s => s.id === selectedStudentId);
    const score = student.parciales.teoricos[unitKey];
    if (score === undefined || score === null || score === '') return;

    const unitName = UNIDADES_TEORICAS[unitKey];

    const uniqueCode = crypto.randomUUID().split('-')[0].toUpperCase();
    const certificateRecord = {
        code: uniqueCode,
        studentId: student.id,
        studentName: student.name,
        practiceName: unitName,
        level: `${score} / 10`,
        type: 'teoria',
        date: new Date().toLocaleDateString('es-MX')
    };
    db.certificate_codes.push(certificateRecord);
    saveData();
    
    const container = document.getElementById('certificate-content');
    container.innerHTML = `
        <h2 class="fredoka text-3xl font-bold tracking-wide" style="color: #F571A3;">Comprobante de Calificación</h2>
        <p class="text-lg mt-1 font-semibold">${HABILIDADES.teoria.name}</p>
        <div class="my-6">
            <p class="text-sm uppercase tracking-wider">Estudiante</p>
            <p class="text-2xl font-bold">${student.name}</p>
        </div>
        <div class="bg-white/70 rounded-lg p-4">
            <p class="text-sm uppercase tracking-wider">Unidad Evaluada</p>
            <p class="text-xl font-semibold">${unitName}</p>
        </div>
        <div class="my-6">
            <p class="text-sm uppercase tracking-wider">Calificación Obtenida</p>
            <p class="fredoka text-6xl mt-2" style="color: #6a4c9c;">${score}<span class="text-3xl">/10</span></p>
        </div>
        <div class="text-xs text-slate-500 mt-6">
            <p>Emitido por: ${db.instructor.name}</p>
            <p>Fecha de Emisión: ${certificateRecord.date}</p>
        </div>
        <div class="mt-4 pt-4 border-t-2 border-dashed border-white/80">
             <p class="text-xs font-semibold">CÓDIGO DE VERIFICACIÓN</p>
             <p class="font-mono text-lg tracking-widest font-bold">${uniqueCode}</p>
        </div>
    `;

    document.getElementById('certificate-modal').classList.add('visible');
    lucide.createIcons();
}

function downloadCertificate() {
    const certificate = document.getElementById('certificate-content');
    const student = db.students.find(s => s.id === selectedStudentId);
    const safeName = student.name.replace(/ /g, '_').toLowerCase();
    
    html2canvas(certificate, { 
        backgroundColor: null, // Transparent background for canvas
        scale: 2 // Higher resolution
    }).then(canvas => {
        const imgData = canvas.toDataURL('image/png');
        const pdf = new jspdf.jsPDF({
            orientation: 'portrait',
            unit: 'px',
            format: [canvas.width, canvas.height]
        });
        pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
        pdf.save(`comprobante_${safeName}.pdf`);
    });
}


function showToast(message) {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.classList.add('show');
    setTimeout(() => {
        toast.classList.remove('show');
    }, 3000);
}

function createSummaryChart(data) {
    const ctx = document.getElementById('summaryChart').getContext('2d');
    if (summaryChart) summaryChart.destroy();
    
    summaryChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: Object.values(data).map(h => h.name),
            datasets: [{
                label: 'PC Obtenidos',
                data: Object.values(data).map(h => h.pc),
                backgroundColor: 'rgba(236, 72, 153, 0.6)',
                borderColor: 'rgba(236, 72, 153, 1)',
                borderWidth: 1
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    beginAtZero: true,
                    title: { display: true, text: 'Puntos de Corazón (PC)' }
                }
            },
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const habilidadKey = Object.keys(data)[context.dataIndex];
                            const totalPC = data[habilidadKey].total;
                            return `PC: ${context.raw} / ${totalPC}`;
                        }
                    }
                }
            }
        }
    });
}

// --- PROGRAM VIEW FUNCTIONS ---
function showProgramView() {
    selectedStudentId = null;
    document.getElementById('evaluation-content').classList.add('hidden');
    document.getElementById('program-content').classList.remove('hidden');
    document.getElementById('tasks-content').classList.add('hidden');
    document.getElementById('student-management-content').classList.add('hidden');
    document.getElementById('no-student-selected').classList.add('hidden');
    
    if (window.innerWidth < 768) {
        toggleMenu();
    }
    
    renderStudentList();
    renderProgramView();
}

function renderProgramView() {
    const container = document.getElementById('program-content');
    
    let programHTML = `
        <div class="flex flex-col md:flex-row gap-8">
            <!-- Vertical Progress Bar -->
            <div class="w-full md:w-24 flex flex-row md:flex-col items-center justify-center gap-4">
                 <h3 class="text-xl font-bold text-pink-800 md:mb-4 [writing-mode:vertical-lr] md:[writing-mode:horizontal-tb] rotate-180 md:rotate-0">Avance</h3>
                 <div class="h-8 md:h-full w-full md:w-8 bg-pink-100 rounded-full relative p-1 border-2 border-pink-200 shadow-inner overflow-hidden flex md:flex-col">
                    <div id="global-program-progress-bar" class="bg-gradient-to-b from-yellow-300 to-amber-400 w-full rounded-full transition-all duration-500 ease-out" style="height: 0%;"></div>
                    <div id="global-program-progress-star" class="absolute left-1/2 md:left-1/2 top-0 md:top-0 transform -translate-x-1/2 md:-translate-x-1/2 transition-all duration-500 ease-out" style="top: 0%;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="#facc15" stroke="#c2410c" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-star" style="filter: drop-shadow(0 0 3px rgba(251, 191, 36, 0.7)); transform: translateY(-50%);">
                            <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                        </svg>
                    </div>
                </div>
            </div>

            <!-- Program Units -->
            <div class="flex-grow">
                 <div class="text-center md:text-left mb-6">
                    <h2 class="fredoka text-3xl sm:text-4xl font-extrabold text-slate-800" style="color: var(--bubblegum-pink);">Avance Programático</h2>
                    <p id="global-program-progress-text" class="font-bold text-slate-700 mt-1"></p>
                </div>
                <div class="space-y-4">
    `;

    db.courseProgram.forEach((unit, unitIndex) => {
        programHTML += `
            <details class="unit-card overflow-hidden" ${unitIndex === 0 ? 'open' : ''}>
                <summary class="flex justify-between items-center cursor-pointer p-4">
                    <h3 class="text-xl fredoka">${unit.unit}</h3>
                    <i data-lucide="chevron-down" class="transition-transform duration-300"></i>
                </summary>
                <div class="p-4 border-t-2 border-pink-100 space-y-4">
        `;
        unit.topics.forEach((topic, topicIndex) => {
            programHTML += `
                <div class="p-4 bg-slate-50 rounded-lg">
                    <div class="flex items-start">
                        <input type="checkbox" id="topic-${unitIndex}-${topicIndex}" onchange="toggleTopic(${unitIndex}, ${topicIndex})" class="mt-1 h-5 w-5 text-pink-600 border-gray-300 rounded focus:ring-pink-500" ${topic.completed ? 'checked' : ''}>
                        <label for="topic-${unitIndex}-${topicIndex}" class="ml-3 text-md font-medium text-slate-700">${topic.name}</label>
                    </div>
                    <textarea onblur="saveNote(${unitIndex}, ${topicIndex}, this.value)" class="mt-2 w-full p-2 border border-slate-200 rounded-lg text-sm" placeholder="Añadir Nota">${topic.notes}</textarea>
                </div>
            `;
        });
        programHTML += `</div></details>`;
    });

    programHTML += `</div></div></div>`;
    container.innerHTML = programHTML;
    updateGlobalProgramProgress(); // Set initial state
    lucide.createIcons();
}

function updateGlobalProgramProgress() {
    const allTopics = db.courseProgram.flatMap(unit => unit.topics);
    const completedTopics = allTopics.filter(topic => topic.completed).length;
    const totalTopics = allTopics.length;
    const progressPercentage = totalTopics > 0 ? (completedTopics / totalTopics) * 100 : 0;
    
    document.getElementById('global-program-progress-bar').style.height = `${progressPercentage}%`;
    document.getElementById('global-program-progress-star').style.top = `${progressPercentage}%`;
    document.getElementById('global-program-progress-text').textContent = `${completedTopics} de ${totalTopics} temas completados (${Math.round(progressPercentage)}%)`;
}

function toggleTopic(unitIndex, topicIndex) {
    db.courseProgram[unitIndex].topics[topicIndex].completed = !db.courseProgram[unitIndex].topics[topicIndex].completed;
    saveData();
    updateGlobalProgramProgress();
}

function saveNote(unitIndex, topicIndex, newNote) {
    db.courseProgram[unitIndex].topics[topicIndex].notes = newNote;
    saveData();
    showToast('Nota guardada.');
}

// --- TASKS VIEW FUNCTIONS ---
function showTasksView() {
    selectedStudentId = null;
    document.getElementById('evaluation-content').classList.add('hidden');
    document.getElementById('program-content').classList.add('hidden');
    document.getElementById('tasks-content').classList.remove('hidden');
    document.getElementById('student-management-content').classList.add('hidden');
    document.getElementById('no-student-selected').classList.add('hidden');

    if (window.innerWidth < 768) {
        toggleMenu();
    }

    renderStudentList();
    renderTasksView();
}

function renderTasksView() {
    const container = document.getElementById('tasks-content');
    const groupColors = { '5-1': 'bg-red-100 text-red-800', '5-2': 'bg-blue-100 text-blue-800', '5-3': 'bg-green-100 text-green-800' };
    container.innerHTML = `
        <h2 class="fredoka text-3xl sm:text-4xl font-extrabold text-slate-800 mb-6" style="color: var(--bubblegum-pink);">Tareas y Actividades</h2>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="kirby-card">
                <h3 class="text-xl font-bold text-pink-800 mb-4">Añadir Nueva Tarea</h3>
                <form id="form-add-task" onsubmit="addNewTask(event)">
                    <div class="space-y-4">
                        <div>
                            <label for="task-name" class="block text-sm font-medium text-slate-700">Descripción de la Tarea</label>
                            <textarea id="task-name" name="name" rows="3" class="mt-1 w-full p-2 border border-slate-300 rounded-lg" required></textarea>
                        </div>
                        
                        <div>
                            <p class="text-sm font-medium text-slate-700">Asignar a Grupos y Definir Fechas</p>
                            <div id="task-group-assignments" class="mt-2 space-y-2">
                                <!-- Dynamic date inputs will appear here -->
                            </div>
                        </div>

                        <button type="submit" class="kirby-button kirby-button-primary w-full">
                            <i data-lucide="plus" class="mr-2"></i>Añadir Tarea
                        </button>
                    </div>
                </form>
            </div>
            <div class="kirby-card">
                <h3 class="text-xl font-bold text-pink-800 mb-4">Lista de Tareas Asignadas</h3>
                <div id="task-list" class="space-y-3 max-h-96 overflow-y-auto pr-2">
                    ${db.tasks.length > 0 ? [...db.tasks].sort((a,b) => new Date(a.assignments[0]?.dueDate) - new Date(b.assignments[0]?.dueDate)).map(task => `
                        <div class="p-4 bg-slate-50 rounded-lg">
                            <div class="flex justify-between items-start">
                                <p class="font-semibold text-slate-800 pr-2">${task.name}</p>
                                <div class="flex-shrink-0 flex gap-1">
                                    <button onclick="openEditTaskModal(${task.id})" class="p-1 text-blue-500 hover:text-blue-700 hover:bg-blue-100 rounded-full"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                                    <button onclick="deleteTask(${task.id})" class="p-1 text-red-500 hover:text-red-700 hover:bg-red-100 rounded-full"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                </div>
                            </div>
                            <div class="mt-2 space-y-1">
                                ${task.assignments.map(a => `<div class="flex items-center gap-2"><span class="text-xs font-bold px-2 py-0.5 rounded-full ${groupColors[a.group] || 'bg-gray-100 text-gray-800'}">G-${a.group}</span> <p class="text-sm text-slate-500"><strong>Entrega:</strong> ${new Date(a.dueDate + 'T00:00:00-07:00').toLocaleDateString('es-MX', { day: '2-digit', month: 'long', year: 'numeric' })}</p></div>`).join('')}
                            </div>
                        </div>
                    `).join('') : '<p class="text-sm text-slate-500">No hay tareas asignadas.</p>'}
                </div>
            </div>
        </div>
    `;
    
    // Dynamically generate group checkboxes with date inputs
    const assignmentContainer = document.getElementById('task-group-assignments');
    ['5-1', '5-2', '5-3'].forEach(group => {
        assignmentContainer.innerHTML += `
            <div class="flex items-center gap-2 p-2 rounded-lg has-[:checked]:bg-pink-50">
                <input type="checkbox" name="group" value="${group}" onchange="this.nextElementSibling.nextElementSibling.classList.toggle('hidden')" class="h-4 w-4 text-pink-600 border-gray-300 rounded"> 
                <label class="font-medium">Grupo ${group}</label>
                <input type="date" name="dueDate-${group}" class="ml-auto p-1 border border-slate-300 rounded-lg hidden">
            </div>
        `;
    });

    lucide.createIcons();
}

function addNewTask(event) {
    event.preventDefault();
    const form = event.target;
    const name = form.elements.name.value;
    
    const assignments = [];
    Array.from(form.elements.group).forEach(checkbox => {
        if (checkbox.checked) {
            const dueDate = form.elements[`dueDate-${checkbox.value}`].value;
            if (!dueDate) {
                showToast(`Error: Por favor, defina una fecha para el grupo ${checkbox.value}.`);
                return;
            }
            assignments.push({ group: checkbox.value, dueDate });
        }
    });

    if (assignments.length === 0) {
        showToast("Error: Debe seleccionar y configurar al menos un grupo.");
        return;
    }
    
    if (assignments.some(a => !a.dueDate)) {
        return; // Stop if any selected group is missing a date
    }

    const newTask = {
        id: Date.now(),
        name,
        assignments
    };

    db.tasks.push(newTask);
    saveData();
    renderTasksView();
    showToast('Tarea añadida exitosamente.');
}

function deleteTask(taskId) {
    db.tasks = db.tasks.filter(t => t.id !== taskId);
    saveData();
    renderTasksView();
    showToast('Tarea eliminada.');
}

function openEditTaskModal(taskId) {
    editingTaskId = taskId;
    const task = db.tasks.find(t => t.id === taskId);
    if (!task) return;

    const modalContainer = document.getElementById('edit-task-modal');
    
    let assignmentsHTML = '';
    ['5-1', '5-2', '5-3'].forEach(group => {
        const assignment = task.assignments.find(a => a.group === group);
        const isChecked = !!assignment;
        const dueDate = assignment ? assignment.dueDate : '';
        assignmentsHTML += `
            <div class="flex items-center gap-2 p-2 rounded-lg has-[:checked]:bg-pink-50">
                <input type="checkbox" name="group" value="${group}" onchange="this.nextElementSibling.nextElementSibling.classList.toggle('hidden')" class="h-4 w-4 text-pink-600 border-gray-300 rounded" ${isChecked ? 'checked' : ''}> 
                <label class="font-medium">Grupo ${group}</label>
                <input type="date" name="dueDate-${group}" value="${dueDate}" class="ml-auto p-1 border border-slate-300 rounded-lg ${isChecked ? '' : 'hidden'}">
            </div>
        `;
    });
    
    modalContainer.innerHTML = `
        <div class="kirby-card w-full max-w-lg modal-content">
            <h3 class="text-xl font-bold text-pink-800 mb-4">Editar Tarea</h3>
            <form id="form-edit-task" onsubmit="saveEditedTask(event)">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700">Descripción</label>
                        <textarea name="name" rows="3" class="mt-1 w-full p-2 border border-slate-300 rounded-lg" required>${task.name}</textarea>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-slate-700">Asignaciones</p>
                        <div class="mt-2 space-y-2">${assignmentsHTML}</div>
                    </div>
                    <div class="flex gap-2">
                        <button type="button" onclick="closeModal('edit-task-modal')" class="kirby-button kirby-button-secondary w-full">Cancelar</button>
                        <button type="submit" class="kirby-button kirby-button-primary w-full">Guardar Cambios</button>
                    </div>
                </div>
            </form>
        </div>
    `;
    modalContainer.classList.add('visible');
}

function saveEditedTask(event) {
    event.preventDefault();
    const form = event.target;
    const name = form.elements.name.value;
    
    const assignments = [];
    Array.from(form.elements.group).forEach(checkbox => {
        if (checkbox.checked) {
            const dueDate = form.elements[`dueDate-${checkbox.value}`].value;
            if (!dueDate) {
                showToast(`Error: Por favor, defina una fecha para el grupo ${checkbox.value}.`);
                return;
            }
            assignments.push({ group: checkbox.value, dueDate });
        }
    });

    if (assignments.length === 0) {
        showToast("Error: Debe seleccionar y configurar al menos un grupo.");
        return;
    }
    if (assignments.some(a => !a.dueDate)) return;

    const taskIndex = db.tasks.findIndex(t => t.id === editingTaskId);
    if (taskIndex > -1) {
        db.tasks[taskIndex].name = name;
        db.tasks[taskIndex].assignments = assignments;
    }
    
    saveData();
    renderTasksView();
    closeModal('edit-task-modal');
    showToast('Tarea actualizada.');
}

// --- STUDENT MANAGEMENT FUNCTIONS ---
function showStudentManagementView() {
    selectedStudentId = null;
    document.getElementById('evaluation-content').classList.add('hidden');
    document.getElementById('program-content').classList.add('hidden');
    document.getElementById('tasks-content').classList.add('hidden');
    document.getElementById('student-management-content').classList.remove('hidden');
    document.getElementById('no-student-selected').classList.add('hidden');

    if (window.innerWidth < 768) {
        toggleMenu();
    }
    renderStudentManagementView();
}

function renderStudentManagementView() {
    const container = document.getElementById('student-management-content');
    container.innerHTML = `
        <h2 class="fredoka text-3xl sm:text-4xl font-extrabold text-slate-800 mb-6" style="color: var(--bubblegum-pink);">Gestionar Lista de Alumnos</h2>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-start">
            <div>
                <div class="kirby-card">
                    <h3 class="text-xl font-bold text-pink-800 mb-4">Añadir Alumno</h3>
                    <form id="form-add-student" onsubmit="addStudent(event)">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700">Nombre Completo</label>
                                <input type="text" name="studentName" class="mt-1 w-full p-2 border border-slate-300 rounded-lg" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700">Grupo</label>
                                <select name="studentGroup" class="mt-1 w-full p-2 border border-slate-300 rounded-lg bg-white">
                                    <option value="5-1">5-1</option>
                                    <option value="5-2">5-2</option>
                                    <option value="5-3">5-3</option>
                                </select>
                            </div>
                            <button type="submit" class="kirby-button kirby-button-primary w-full">
                                <i data-lucide="user-plus" class="mr-2"></i>Añadir Alumno
                            </button>
                        </div>
                    </form>
                </div>
                <div class="kirby-card mt-8 border-red-300">
                    <h3 class="text-xl font-bold text-red-800 mb-4">Zona de Peligro</h3>
                    <div class="space-y-4">
                        <div class="p-4 bg-red-50 rounded-lg">
                            <label class="block text-sm font-medium text-red-700">Eliminar todos los alumnos de un grupo</label>
                            <div class="flex gap-2 mt-2">
                                <select id="delete-group-select" class="w-full p-2 border border-slate-300 rounded-lg bg-white">
                                    <option value="5-1">Grupo 5-1</option><option value="5-2">Grupo 5-2</option><option value="5-3">Grupo 5-3</option>
                                </select>
                                <button onclick="deleteGroupStudents()" class="kirby-button bg-red-500 text-white hover:bg-red-700 flex-shrink-0">Eliminar</button>
                            </div>
                        </div>
                         <div class="p-4 bg-red-50 rounded-lg">
                            <label class="block text-sm font-medium text-red-700">Eliminar TODOS los alumnos del sistema</label>
                            <p class="text-xs text-red-600">Esta acción no se puede deshacer y es ideal para reiniciar el semestre.</p>
                            <button onclick="deleteAllStudents()" class="kirby-button bg-red-500 text-white hover:bg-red-700 w-full mt-2">Eliminar Todo</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="kirby-card">
                 <h3 class="text-xl font-bold text-pink-800 mb-4">Lista de Alumnos Actual</h3>
                 <div id="student-management-list" class="space-y-2 max-h-[60vh] overflow-y-auto pr-2">
                    <!-- Student management list is rendered here -->
                 </div>
            </div>
        </div>
    `;
    renderStudentManagementList();
    lucide.createIcons();
}

function renderStudentManagementList() {
    const listContainer = document.getElementById('student-management-list');
    listContainer.innerHTML = [...db.students].sort((a, b) => a.name.localeCompare(b.name)).map(student => `
        <div class="p-2 bg-slate-50 rounded-lg flex items-center gap-2">
            <input type="text" value="${student.name}" onchange="updateStudentName(${student.id}, this.value)" class="w-full bg-transparent p-1 font-semibold text-slate-800">
            <select onchange="updateStudentGroup(${student.id}, this.value)" class="p-1 border-0 bg-transparent rounded-lg text-sm">
                <option value="5-1" ${student.group === '5-1' ? 'selected' : ''}>5-1</option>
                <option value="5-2" ${student.group === '5-2' ? 'selected' : ''}>5-2</option>
                <option value="5-3" ${student.group === '5-3' ? 'selected' : ''}>5-3</option>
            </select>
            <button onclick="deleteStudent(${student.id})" class="p-1 text-red-500 hover:text-red-700 hover:bg-red-100 rounded-full flex-shrink-0"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
        </div>
    `).join('');
    lucide.createIcons();
}

function addStudent(event) {
    event.preventDefault();
    const form = event.target;
    const name = form.elements.studentName.value.trim().toUpperCase();
    const group = form.elements.studentGroup.value;

    if (!name) {
        showToast('El nombre del alumno no puede estar vacío.');
        return;
    }

    const newId = db.students.length > 0 ? Math.max(...db.students.map(s => s.id)) + 1 : 1;
    
    db.students.push({
        id: newId,
        name,
        group,
        avatar: generateAvatarUrl(name),
        evaluations: [],
        parciales: { practicas: {}, teoricos: {} },
        constancia_details: {
            total_clases: 0, asistencias: 0, inasistencias: 0, justificantes: 0, retardos: 0,
            total_tareas: 0, entregadas: 0, retardos_tareas: 0, no_entregadas: 0,
            participacion: 'nula', bio_heroe_extra: false
        }
    });

    saveData();
    renderStudentManagementList();
    renderStudentList();
    showToast('Alumno añadido.');
    form.reset();
}

function updateStudentName(studentId, newName) {
    const student = db.students.find(s => s.id === studentId);
    if (student) {
        student.name = newName.trim().toUpperCase();
        saveData();
        renderStudentList();
        showToast('Nombre actualizado.');
    }
}

function updateStudentGroup(studentId, newGroup) {
     const student = db.students.find(s => s.id === studentId);
    if (student) {
        student.group = newGroup;
        saveData();
        renderStudentList();
        showToast('Grupo actualizado.');
    }
}

function deleteStudent(studentId) {
    if (confirm(`¿Está seguro de que desea eliminar a este alumno? Esta acción no se puede deshacer.`)) {
        db.students = db.students.filter(s => s.id !== studentId);
        saveData();
        renderStudentManagementList();
        renderStudentList();
        showToast('Alumno eliminado.');
    }
}

function deleteGroupStudents() {
    const group = document.getElementById('delete-group-select').value;
    if (confirm(`¿ESTÁ SEGURO? Se eliminarán TODOS los alumnos del grupo ${group}. Esta acción es irreversible.`)) {
        db.students = db.students.filter(s => s.group !== group);
        saveData();
        renderStudentManagementList();
        renderStudentList();
        showToast(`Alumnos del grupo ${group} eliminados.`);
    }
}

function deleteAllStudents() {
     if (confirm(`¡ADVERTENCIA FINAL! ¿Está completamente seguro de que desea eliminar a TODOS los alumnos de TODOS los grupos? Esta acción no se puede deshacer.`)) {
        db.students = [];
        db.certificate_codes = [];
        db.tasks = [];
        db.courseProgram = courseProgramData;
        saveData();
        renderStudentManagementList();
        renderStudentList();
        showToast('Todos los alumnos han sido eliminados. El sistema está listo para el nuevo semestre.');
    }
}

</script>

</body>
</html>

